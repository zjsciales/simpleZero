{% extends "base.html" %}

{% block title %}🎯 Trade Management - SPY Trading System{% endblock %}

{% block content %}
<div class="trade-container">
    <div class="trade-header">
        <h1>🎯 Trade Management</h1>
        <div class="environment-indicator environment-{{ environment.lower() }}">
            {{ environment }} Environment
        </div>
    </div>

    <!-- Authentication Status Panel -->
    <div class="auth-panel">
        <div class="auth-section">
            <h3>🏭 Production Authentication</h3>
            <div class="auth-status {{ 'authenticated' if prod_authenticated else 'not-authenticated' }}">
                {% if prod_authenticated %}
                    ✅ Connected to Production (Data Only)
                {% else %}
                    ❌ Not Connected
                {% endif %}
            </div>
        </div>

        <div class="auth-section">
            <h3>🧪 Sandbox Authentication</h3>
            <div class="auth-status {{ 'authenticated' if sandbox_authenticated else 'not-authenticated' }}">
                {% if sandbox_authenticated %}
                    ✅ Connected to Sandbox (Trading Ready)
                {% else %}
                    ❌ Not Connected - Login Required for Trading
                {% endif %}
            </div>
            
            {% if not sandbox_authenticated %}
            <div class="sandbox-login-form" style="margin-top: 15px;">
                <h4>Connect to TastyTrade Sandbox</h4>
                <p>You'll be redirected to TastyTrade to authorize sandbox access for safe testing.</p>
                <a href="/sandbox-auth" class="btn btn-primary">🔐 Connect Sandbox via OAuth</a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Parsed Trade Display -->
    {% if parsed_trade %}
    <div class="trade-display">
        <div class="trade-header-info">
            <h2>📊 Parsed Trade Signal</h2>
            <div class="trade-timestamp">
                Generated: {{ parsed_trade.timestamp }}
            </div>
        </div>

        <div class="trade-details">
            <div class="strategy-info">
                <div class="strategy-badge strategy-{{ parsed_trade.strategy.lower().replace('_', '-') }}">
                    {{ parsed_trade.strategy.replace('_', ' ').title() }}
                </div>
                <div class="confidence-score">
                    Confidence: {{ parsed_trade.confidence }}%
                </div>
            </div>

            <div class="trade-specs">
                <div class="spec-group">
                    <h4>📈 Underlying</h4>
                    <span class="spec-value">{{ parsed_trade.underlying }}</span>
                </div>

                <div class="spec-group">
                    <h4>🎯 Strikes</h4>
                    <span class="spec-value">
                        Short: ${{ parsed_trade.short_strike }} / Long: ${{ parsed_trade.long_strike }}
                    </span>
                </div>

                <div class="spec-group">
                    <h4>📅 Expiration</h4>
                    <span class="spec-value">{{ parsed_trade.expiration_date }}</span>
                </div>

                <div class="spec-group">
                    <h4>💰 Expected Credit</h4>
                    <span class="spec-value">${{ "%.2f"|format(parsed_trade.credit) }}</span>
                </div>

                <div class="spec-group">
                    <h4>📊 Market Bias</h4>
                    <span class="spec-value bias-{{ parsed_trade.market_bias }}">
                        {{ parsed_trade.market_bias.title() }}
                    </span>
                </div>
            </div>

            <!-- Contract Details -->
            <div class="contract-details">
                <h4>📋 Contract Legs</h4>
                <div class="legs-container">
                    {% if parsed_trade.strategy == 'BULL_PUT_SPREAD' %}
                        <div class="leg leg-short">
                            <span class="leg-action">SELL TO OPEN</span>
                            <span class="leg-contract">{{ parsed_trade.underlying }} {{ parsed_trade.expiration_date }}P{{ "%.0f"|format(parsed_trade.short_strike * 1000) }}</span>
                        </div>
                        <div class="leg leg-long">
                            <span class="leg-action">BUY TO OPEN</span>
                            <span class="leg-contract">{{ parsed_trade.underlying }} {{ parsed_trade.expiration_date }}P{{ "%.0f"|format(parsed_trade.long_strike * 1000) }}</span>
                        </div>
                    {% elif parsed_trade.strategy == 'BEAR_CALL_SPREAD' %}
                        <div class="leg leg-short">
                            <span class="leg-action">SELL TO OPEN</span>
                            <span class="leg-contract">{{ parsed_trade.underlying }} {{ parsed_trade.expiration_date }}C{{ "%.0f"|format(parsed_trade.short_strike * 1000) }}</span>
                        </div>
                        <div class="leg leg-long">
                            <span class="leg-action">BUY TO OPEN</span>
                            <span class="leg-contract">{{ parsed_trade.underlying }} {{ parsed_trade.expiration_date }}C{{ "%.0f"|format(parsed_trade.long_strike * 1000) }}</span>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Trade Actions -->
            <div class="trade-actions">
                {% if sandbox_authenticated %}
                    <button id="validateTradeBtn" class="btn btn-secondary">🔍 Validate Trade</button>
                    <button id="executeTradeBtn" class="btn btn-primary">🚀 Execute Trade</button>
                {% else %}
                    <div class="action-disabled">
                        🔒 Sandbox authentication required for trading
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="no-trade">
        <div class="no-trade-content">
            <h2>📭 No Trade Signal Available</h2>
            <p>Request a Grok analysis from the <a href="/dashboard">dashboard</a> to generate trade signals.</p>
            <a href="/dashboard" class="btn btn-primary">📊 Go to Dashboard</a>
        </div>
    </div>
    {% endif %}

    <!-- Execution Results -->
    <div id="executionResults" class="execution-results" style="display: none;">
        <!-- Results will be populated via JavaScript -->
    </div>
</div>

<style>
.trade-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

.trade-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.environment-indicator {
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 12px;
}

.environment-sandbox {
    background: #fef3c7;
    color: #d97706;
    border: 1px solid #f59e0b;
}

.environment-production {
    background: #fee2e2;
    color: #dc2626;
    border: 1px solid #ef4444;
}

.auth-panel {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.auth-section h3 {
    margin-bottom: 10px;
    color: #374151;
}

.auth-status {
    padding: 10px;
    border-radius: 6px;
    font-weight: 500;
}

.auth-status.authenticated {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #22c55e;
}

.auth-status.not-authenticated {
    background: #fef2f2;
    color: #dc2626;
    border: 1px solid #ef4444;
}

.sandbox-login-form {
    padding: 15px;
    background: #f9fafb;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
}

.sandbox-login-form h4 {
    margin-bottom: 10px;
    color: #374151;
}

.form-group {
    margin-bottom: 10px;
}

.form-group input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 14px;
}

.trade-display {
    background: white;
    border-radius: 8px;
    padding: 25px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
}

.trade-header-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e5e7eb;
}

.trade-timestamp {
    color: #6b7280;
    font-size: 14px;
}

.strategy-info {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}

.strategy-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 12px;
}

.strategy-bull-put-spread {
    background: #dcfce7;
    color: #166534;
}

.strategy-bear-call-spread {
    background: #fef3c7;
    color: #d97706;
}

.confidence-score {
    background: #eff6ff;
    color: #1d4ed8;
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 500;
}

.trade-specs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.spec-group {
    padding: 15px;
    background: #f9fafb;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
}

.spec-group h4 {
    color: #6b7280;
    font-size: 12px;
    text-transform: uppercase;
    margin-bottom: 5px;
}

.spec-value {
    color: #111827;
    font-weight: 600;
    font-size: 16px;
}

.bias-bullish {
    color: #059669;
}

.bias-bearish {
    color: #dc2626;
}

.contract-details {
    margin-bottom: 25px;
}

.contract-details h4 {
    margin-bottom: 15px;
    color: #374151;
}

.legs-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.leg {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-radius: 6px;
    font-family: 'Monaco', 'Courier New', monospace;
}

.leg-short {
    background: #fef2f2;
    border: 1px solid #fecaca;
}

.leg-long {
    background: #ecfdf5;
    border: 1px solid #bbf7d0;
}

.leg-action {
    font-weight: 600;
    font-size: 12px;
}

.leg-contract {
    font-weight: 500;
}

.trade-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid #e5e7eb;
}

.btn {
    padding: 12px 24px;
    border-radius: 6px;
    font-weight: 600;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
}

.btn-secondary {
    background: #6b7280;
    color: white;
}

.btn-secondary:hover {
    background: #4b5563;
}

.action-disabled {
    color: #6b7280;
    font-style: italic;
    text-align: center;
    padding: 12px;
}

.no-trade {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.no-trade-content h2 {
    color: #6b7280;
    margin-bottom: 15px;
}

.no-trade-content p {
    color: #9ca3af;
    margin-bottom: 25px;
}

.execution-results {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
</style>

<script>
// Sandbox OAuth - no form handler needed, handled by server redirect

// Trade validation handler
document.getElementById('validateTradeBtn')?.addEventListener('click', async function() {
    const btn = this;
    btn.textContent = '🔄 Validating...';
    btn.disabled = true;
    
    try {
        // Here we would validate the trade parameters
        // For now, just show success
        setTimeout(() => {
            alert('✅ Trade validation successful!\n\nAll parameters look good for execution.');
            btn.textContent = '🔍 Validate Trade';
            btn.disabled = false;
        }, 2000);
    } catch (error) {
        alert('❌ Validation failed: ' + error.message);
        btn.textContent = '🔍 Validate Trade';
        btn.disabled = false;
    }
});

// Trade execution handler
document.getElementById('executeTradeBtn')?.addEventListener('click', async function() {
    const btn = this;
    
    // Confirmation dialog
    const confirmed = confirm('🚀 Execute this trade in the Sandbox environment?\n\nThis will submit a real order to TastyTrade Sandbox.');
    if (!confirmed) return;
    
    btn.textContent = '🚀 Executing...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/execute-trade', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show success message
            const resultsDiv = document.getElementById('executionResults');
            resultsDiv.innerHTML = `
                <div style="background: #dcfce7; border: 1px solid #22c55e; color: #166534; padding: 15px; border-radius: 6px;">
                    <h3>✅ Trade Executed Successfully!</h3>
                    <p><strong>Order ID:</strong> ${result.order_id || 'N/A'}</p>
                    <p><strong>Status:</strong> ${result.result?.status || 'Submitted'}</p>
                    <pre style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 4px; font-size: 12px;">${JSON.stringify(result.result, null, 2)}</pre>
                </div>
            `;
            resultsDiv.style.display = 'block';
        } else {
            // Show error
            const resultsDiv = document.getElementById('executionResults');
            resultsDiv.innerHTML = `
                <div style="background: #fef2f2; border: 1px solid #ef4444; color: #dc2626; padding: 15px; border-radius: 6px;">
                    <h3>❌ Trade Execution Failed</h3>
                    <p>${result.error || 'Unknown error occurred'}</p>
                    ${result.details ? `<pre style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 4px; font-size: 12px;">${JSON.stringify(result.details, null, 2)}</pre>` : ''}
                </div>
            `;
            resultsDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('Trade execution error:', error);
        const resultsDiv = document.getElementById('executionResults');
        resultsDiv.innerHTML = `
            <div style="background: #fef2f2; border: 1px solid #ef4444; color: #dc2626; padding: 15px; border-radius: 6px;">
                <h3>❌ Connection Error</h3>
                <p>${error.message}</p>
            </div>
        `;
        resultsDiv.style.display = 'block';
    } finally {
        btn.textContent = '🚀 Execute Trade';
        btn.disabled = false;
    }
});
</script>
{% endblock %}