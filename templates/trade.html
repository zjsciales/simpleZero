{% extends "base.html" %}

{% block title %}üéØ Trade Management - SPY Trading System{% endblock %}

{% block content %}
<div class="trade-container">
    <div class="trade-header">
        <h1>üéØ Trade Management</h1>
        <div class="environment-indicator environment-{{ environment.lower() }}">
            {{ environment }} Environment
        </div>
    </div>

    <!-- Authentication Status Panel -->
    <div class="auth-panel">
        <div class="auth-section">
            <h3>üîê {{ environment }} Environment Authentication</h3>
            <div class="auth-status {{ 'authenticated' if authenticated else 'not-authenticated' }}">
                {% if authenticated %}
                    ‚úÖ Connected to {{ environment }}
                    {% if environment == 'SANDBOX' %}
                        (Trading Enabled)
                    {% else %}
                        (Production Mode)
                    {% endif %}
                {% else %}
                    ‚ùå Not Connected to {{ environment }}
                {% endif %}
            </div>
        </div>
        
        {% if not authenticated %}
            <div class="auth-warning">
                ‚ö†Ô∏è Connect to {{ environment.lower() }} to enable trading functionality
            </div>
        {% endif %}
    </div>

    <!-- Authentication Panel (if not authenticated) -->
    {% if authenticated %}
        <!-- Trade data display when authenticated -->
    {% endif %}

    <!-- Parsed Trade Display -->
    {% if parsed_trade %}
    <div class="trade-display">
        <div class="trade-header-info">
            <h2>üìä Current Trade Analysis</h2>
        </div>

        <div class="trade-details">
            <div class="strategy-info">
                {% if parsed_trade and parsed_trade.strategy_type and parsed_trade.strategy_type != None %}
                <div class="strategy-badge strategy-{{ (parsed_trade.strategy_type|string|lower|replace('_', '-')) }}">
                    {{ (parsed_trade.strategy_type|string|replace('_', ' ')|title) }}
                </div>
                {% else %}
                <div class="strategy-badge strategy-unknown">
                    Unknown Strategy
                </div>
                {% endif %}
                <div class="confidence-score">
                    Confidence: {{ parsed_trade.confidence or 'N/A' }}%
                </div>
            </div>

            <div class="trade-specs">
                <div class="spec-group">
                    <h4>üìà Underlying</h4>
                    <span class="spec-value">{{ parsed_trade.underlying or parsed_trade.ticker or 'N/A' }}</span>
                </div>

                <div class="spec-group">
                    <h4>üéØ Strikes</h4>
                    <span class="spec-value">
                        Short: ${{ parsed_trade.short_strike or 'N/A' }} / Long: ${{ parsed_trade.long_strike or 'N/A' }}
                    </span>
                </div>

                <div class="spec-group">
                    <h4>üìÖ Expiration</h4>
                    <span class="spec-value">{{ parsed_trade.expiration or 'N/A' }}</span>
                </div>

                <div class="spec-group">
                    <h4>üí∞ Expected Credit</h4>
                    <span class="spec-value">${{ "%.2f"|format(parsed_trade.credit_received or 0) }}</span>
                </div>

                <div class="spec-group">
                    <h4>üìä Market Bias</h4>
                    <span class="spec-value bias-{{ parsed_trade.market_bias or 'neutral' }}">
                        {{ (parsed_trade.market_bias or 'Unknown').title() }}
                    </span>
                </div>
            </div>

            <!-- Contract Details -->
            <div class="contract-details">
                <h4>üìã Contract Legs</h4>
                <div class="legs-container">
                    {% if parsed_trade and parsed_trade.strategy_type %}
                        {% if parsed_trade.strategy_type == 'BULL_PUT_SPREAD' %}
                            <div class="leg leg-short">
                                <span class="leg-action">SELL TO OPEN</span>
                                <span class="leg-contract">{{ parsed_trade.underlying_symbol or 'SPY' }} {{ parsed_trade.expiration or 'TBD' }}P{{ "%.0f"|format((parsed_trade.short_strike or 0) * 1000) }}</span>
                            </div>
                            <div class="leg leg-long">
                                <span class="leg-action">BUY TO OPEN</span>
                                <span class="leg-contract">{{ parsed_trade.underlying_symbol or 'SPY' }} {{ parsed_trade.expiration or 'TBD' }}P{{ "%.0f"|format((parsed_trade.long_strike or 0) * 1000) }}</span>
                            </div>
                        {% elif parsed_trade.strategy_type == 'BEAR_CALL_SPREAD' %}
                            <div class="leg leg-short">
                                <span class="leg-action">SELL TO OPEN</span>
                                <span class="leg-contract">{{ parsed_trade.underlying_symbol or 'SPY' }} {{ parsed_trade.expiration or 'TBD' }}C{{ "%.0f"|format((parsed_trade.short_strike or 0) * 1000) }}</span>
                            </div>
                            <div class="leg leg-long">
                                <span class="leg-action">BUY TO OPEN</span>
                                <span class="leg-contract">{{ parsed_trade.underlying_symbol or 'SPY' }} {{ parsed_trade.expiration or 'TBD' }}C{{ "%.0f"|format((parsed_trade.long_strike or 0) * 1000) }}</span>
                            </div>
                        {% else %}
                            <div class="leg">
                                <span class="leg-action">Strategy details not available</span>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="leg">
                            <span class="leg-action">No trade data available</span>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Trade Actions -->
            <div class="trade-actions">
                {% if authenticated %}
                    <button id="validateTradeBtn" class="btn btn-secondary">üîç Validate Trade</button>
                    <button id="executeTradeBtn" class="btn btn-primary">üöÄ Execute Trade</button>
                {% else %}
                    <div class="auth-required">
                        <p>üîê {{ environment }} authentication required for trading</p>
                        <button class="btn btn-outline" onclick="window.location.href='/login'">Connect to {{ environment }}</button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="no-trade-data">
        <div class="no-trade-content">
            <h2>üì≠ No Trade Signal Available</h2>
            <p>Request a Grok analysis from the <a href="/dashboard">dashboard</a> to generate trade signals.</p>
            <a href="/dashboard" class="btn btn-primary">üìä Go to Dashboard</a>
        </div>
    </div>
    {% endif %}

    <!-- Execution Results -->
    <div id="executionResults" class="execution-results" style="display: none;">
        <!-- Results will be populated via JavaScript -->
    </div>

    <!-- Account Streaming Monitor -->
    {% if authenticated %}
    <div class="streaming-monitor">
        <div class="streaming-header">
            <h2>üì° Real-Time Account Monitor</h2>
            <p class="streaming-description">Live order status, fills, and account updates</p>
        </div>
        
        <div class="streaming-content">
            <div class="streaming-controls">
                <div class="control-row">
                    <button onclick="toggleAccountStreaming()" id="streaming-btn" class="btn btn-success">
                        üî¥ Start Monitoring
                    </button>
                    <button onclick="refreshStreamingStatus()" id="status-btn" class="btn btn-outline">
                        üîÑ Refresh Status
                    </button>
                </div>
                
                <div class="control-row">
                    <button onclick="testOrderMessage()" id="test-order-btn" class="btn btn-outline" style="font-size: 12px;">
                        üß™ Test Order
                    </button>
                    <button onclick="testFillMessage()" id="test-fill-btn" class="btn btn-outline" style="font-size: 12px;">
                        üß™ Test Fill
                    </button>
                </div>
                
                <div id="streaming-status" class="streaming-status">
                    <div class="status-indicator offline">
                        <span class="status-dot"></span>
                        <span>Disconnected</span>
                    </div>
                </div>
            </div>
            
            <div id="streaming-info" class="streaming-info" style="display: none;">
                <div class="info-grid">
                    <div class="info-item">
                        <label>Session ID:</label>
                        <span id="session-id">-</span>
                    </div>
                    <div class="info-item">
                        <label>Accounts:</label>
                        <span id="monitored-accounts">-</span>
                    </div>
                    <div class="info-item">
                        <label>Order Events:</label>
                        <span id="message-count">0</span>
                    </div>
                    <div class="info-item">
                        <label>Uptime:</label>
                        <span id="uptime">0s</span>
                    </div>
                </div>
            </div>
            
            <div id="streaming-messages" class="streaming-messages">
                <h4>üìã Order & Fill Activity</h4>
                <div id="message-log" class="message-log">
                    <div class="message-item info">
                        <span class="timestamp">Ready</span>
                        <span class="content">Click "Start Monitoring" to begin real-time account tracking</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.trade-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.trade-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    text-align: center;
}

.environment-indicator {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    margin-top: 10px;
}

.environment-sandbox {
    background: rgba(255, 193, 7, 0.2);
    border: 2px solid #ffc107;
}

.environment-production {
    background: rgba(220, 53, 69, 0.2);
    border: 2px solid #dc3545;
}

.auth-panel {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.auth-section {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
}

.auth-status {
    padding: 10px;
    border-radius: 6px;
    text-align: center;
    font-weight: 600;
    margin-top: 10px;
}

.auth-status.authenticated {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.auth-status.not-authenticated {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.trade-display {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
}

.strategy-info {
    text-align: center;
    margin-bottom: 30px;
}

.strategy-badge {
    display: inline-block;
    padding: 12px 24px;
    border-radius: 25px;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 15px;
}

.strategy-bull-put-spread {
    background: #d4edda;
    color: #155724;
    border: 2px solid #28a745;
}

.strategy-bear-call-spread {
    background: #f8d7da;
    color: #721c24;
    border: 2px solid #dc3545;
}

.strategy-unknown {
    background: #f8f9fa;
    color: #6c757d;
    border: 2px solid #6c757d;
}

.confidence-score {
    font-size: 16px;
    color: #6c757d;
}

.trade-specs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.spec-group {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
}

.spec-group h4 {
    margin: 0 0 10px 0;
    color: #495057;
    font-size: 14px;
}

.spec-value {
    font-size: 18px;
    font-weight: 600;
    color: #212529;
}

.contract-details {
    margin-bottom: 30px;
}

.legs-container {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

.leg {
    flex: 1;
    min-width: 250px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
}

.leg-short {
    border-left: 4px solid #dc3545;
}

.leg-long {
    border-left: 4px solid #28a745;
}

.leg-action {
    display: block;
    font-weight: 600;
    color: #495057;
    margin-bottom: 10px;
}

.leg-contract {
    display: block;
    font-size: 16px;
    font-family: monospace;
    color: #212529;
}

.trade-actions {
    text-align: center;
}

.btn {
    display: inline-block;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    margin: 0 10px;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.no-trade-data {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
}

.execution-results {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
}

/* Streaming Monitor Styles */
.streaming-monitor {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 30px;
    margin-top: 30px;
}

.streaming-header {
    text-align: center;
    margin-bottom: 25px;
}

.streaming-header h2 {
    color: #2c3e50;
    margin-bottom: 5px;
}

.streaming-description {
    color: #6c757d;
    margin: 0;
}

.streaming-content {
    display: grid;
    gap: 25px;
}

.streaming-controls {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.control-row {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}

.streaming-status {
    display: flex;
    align-items: center;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.status-indicator.online {
    background: rgba(40, 167, 69, 0.1);
    color: #28a745;
    border: 1px solid #28a745;
}

.status-indicator.offline {
    background: rgba(220, 53, 69, 0.1);
    color: #dc3545;
    border: 1px solid #dc3545;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.streaming-info {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.info-item label {
    font-weight: 600;
    color: #495057;
    font-size: 14px;
}

.info-item span {
    color: #6c757d;
    font-family: 'Courier New', monospace;
}

.streaming-messages {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
}

.streaming-messages h4 {
    margin-bottom: 15px;
    color: #495057;
}

.message-log {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    background: white;
}

.message-item {
    display: flex;
    gap: 15px;
    padding: 10px 15px;
    border-bottom: 1px solid #f1f3f4;
    font-size: 14px;
}

.message-item:last-child {
    border-bottom: none;
}

.message-item.info {
    background: rgba(23, 162, 184, 0.05);
    border-left: 3px solid #17a2b8;
}

.message-item.success {
    background: rgba(40, 167, 69, 0.05);
    border-left: 3px solid #28a745;
}

.message-item.warning {
    background: rgba(255, 193, 7, 0.05);
    border-left: 3px solid #ffc107;
}

.message-item.error {
    background: rgba(220, 53, 69, 0.05);
    border-left: 3px solid #dc3545;
}

.message-item .timestamp {
    color: #6c757d;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    min-width: 70px;
    flex-shrink: 0;
}

.message-item .content {
    color: #495057;
    flex: 1;
}
</style>

<script>
// Account Streaming Functions
let streamingActive = false;
let statusRefreshInterval;

async function toggleAccountStreaming() {
    const btn = document.getElementById('streaming-btn');
    
    try {
        if (!streamingActive) {
            // Start streaming
            btn.disabled = true;
            btn.textContent = 'Starting...';
            
            const response = await fetch('/api/account-streaming', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: 'start' })
            });
            
            const data = await response.json();
            
            if (data.success) {
                streamingActive = true;
                btn.textContent = 'üü¢ Stop Monitoring';
                btn.className = 'btn btn-warning';
                
                updateStreamingStatus(data.status);
                addMessageToLog('success', 'Account streaming started successfully');
                
                // Start status refresh
                startStatusRefresh();
            } else {
                throw new Error(data.message || 'Failed to start streaming');
            }
        } else {
            // Stop streaming
            btn.disabled = true;
            btn.textContent = 'Stopping...';
            
            const response = await fetch('/api/account-streaming', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: 'stop' })
            });
            
            const data = await response.json();
            
            if (data.success) {
                streamingActive = false;
                btn.textContent = 'üî¥ Start Monitoring';
                btn.className = 'btn btn-success';
                
                updateStreamingStatus({ active: false, connected: false });
                addMessageToLog('info', 'Account streaming stopped');
                
                // Stop status refresh
                stopStatusRefresh();
            } else {
                throw new Error(data.message || 'Failed to stop streaming');
            }
        }
    } catch (error) {
        console.error('Streaming toggle error:', error);
        addMessageToLog('error', 'Error: ' + error.message);
    } finally {
        btn.disabled = false;
    }
}

async function refreshStreamingStatus() {
    try {
        const response = await fetch('/api/account-streaming');
        const data = await response.json();
        
        console.log('Status response:', data); // Debug logging
        
        if (data.success) {
            updateStreamingStatus(data.status);
            addMessageToLog('info', 'Status refreshed');
        } else {
            throw new Error('Failed to get status');
        }
    } catch (error) {
        console.error('Status refresh error:', error);
        addMessageToLog('error', 'Status refresh failed: ' + error.message);
    }
}

function updateStreamingStatus(status) {
    console.log('Updating status:', status); // Debug logging
    
    const statusIndicator = document.querySelector('.status-indicator');
    const streamingInfo = document.getElementById('streaming-info');
    
    if (status.active && status.connected) {
        statusIndicator.className = 'status-indicator online';
        statusIndicator.innerHTML = '<span class="status-dot"></span><span>Connected</span>';
        streamingInfo.style.display = 'block';
        
        // Update info details
        document.getElementById('session-id').textContent = status.session_id || '-';
        document.getElementById('monitored-accounts').textContent = 
            status.accounts ? status.accounts.join(', ') : '-';
        document.getElementById('message-count').textContent = 
            status.recent_messages ? status.recent_messages.length : 0;
        document.getElementById('uptime').textContent = formatUptime(status.uptime || 0);
    } else {
        statusIndicator.className = 'status-indicator offline';
        statusIndicator.innerHTML = '<span class="status-dot"></span><span>Disconnected</span>';
        streamingInfo.style.display = 'none';
    }
    
    // Always update recent messages regardless of connection status
    console.log('Recent messages:', status.recent_messages); // Debug logging
    if (status.recent_messages && status.recent_messages.length > 0) {
        updateRecentMessages(status.recent_messages);
    } else {
        // Show empty state if no messages
        updateRecentMessages([]);
    }
}

function updateRecentMessages(messages) {
    const messageLog = document.getElementById('message-log');
    
    // Clear existing messages except the ready message
    const readyMessage = messageLog.querySelector('.message-item.info');
    messageLog.innerHTML = '';
    
    // Add recent messages from websocket
    messages.forEach(msg => {
        const messageItem = document.createElement('div');
        messageItem.className = 'message-item ' + (msg.category || 'info');
        
        // Format timestamp
        const msgTime = new Date(msg.timestamp);
        const timeStr = msgTime.toLocaleTimeString();
        
        messageItem.innerHTML = 
            '<span class="timestamp">' + timeStr + '</span>' +
            '<span class="content">' + msg.message + '</span>';
        
        messageLog.appendChild(messageItem);
    });
    
    // If no messages, add ready message back
    if (messages.length === 0 && readyMessage) {
        messageLog.appendChild(readyMessage);
    } else if (messages.length === 0) {
        messageLog.innerHTML = 
            '<div class="message-item info">' +
            '<span class="timestamp">Ready</span>' +
            '<span class="content">Waiting for order and fill notifications...</span>' +
            '</div>';
    }
}

function formatUptime(seconds) {
    if (seconds < 60) return seconds + 's';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ' + (seconds % 60) + 's';
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    return hours + 'h ' + minutes + 'm';
}

function addMessageToLog(type, message) {
    const messageLog = document.getElementById('message-log');
    const timestamp = new Date().toLocaleTimeString();
    
    const messageItem = document.createElement('div');
    messageItem.className = 'message-item ' + type;
    messageItem.innerHTML = 
        '<span class="timestamp">' + timestamp + '</span>' +
        '<span class="content">' + message + '</span>';
    
    // Add to top
    messageLog.insertBefore(messageItem, messageLog.firstChild);
    
    // Keep only last 20 messages
    while (messageLog.children.length > 20) {
        messageLog.removeChild(messageLog.lastChild);
    }
}

function startStatusRefresh() {
    if (statusRefreshInterval) clearInterval(statusRefreshInterval);
    
    statusRefreshInterval = setInterval(async () => {
        if (streamingActive) {
            await refreshStreamingStatus();
        }
    }, 10000); // Refresh every 10 seconds
}

function stopStatusRefresh() {
    if (statusRefreshInterval) {
        clearInterval(statusRefreshInterval);
        statusRefreshInterval = null;
    }
}

async function testOrderMessage() {
    try {
        const response = await fetch('/api/test-order-message', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            // Refresh status to show new message
            await refreshStreamingStatus();
        } else {
            addMessageToLog('error', 'Failed to add test order message');
        }
    } catch (error) {
        console.error('Test order message error:', error);
        addMessageToLog('error', 'Error adding test order message');
    }
}

async function testFillMessage() {
    try {
        const response = await fetch('/api/test-fill-message', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            // Refresh status to show new message
            await refreshStreamingStatus();
        } else {
            addMessageToLog('error', 'Failed to add test fill message');
        }
    } catch (error) {
        console.error('Test fill message error:', error);
        addMessageToLog('error', 'Error adding test fill message');
    }
}

// Initialize streaming status on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check initial streaming status
    refreshStreamingStatus();
});
</script>

<script>
// Trade validation and execution functionality
document.addEventListener('DOMContentLoaded', function() {
    const validateBtn = document.getElementById('validateTradeBtn');
    const executeBtn = document.getElementById('executeTradeBtn');
    const resultsDiv = document.getElementById('executionResults');

    if (validateBtn) {
        validateBtn.addEventListener('click', validateTrade);
    }

    if (executeBtn) {
        executeBtn.addEventListener('click', executeTrade);
    }
});

async function validateTrade() {
    console.log('üîç Validating trade...');
    // Add validation logic here
}

async function executeTrade() {
    console.log('üöÄ Executing real trade...');
    const resultsDiv = document.getElementById('executionResults');
    
    try {
        const response = await fetch('/api/execute-trade', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        resultsDiv.style.display = 'block';
        if (result.success) {
            // Show success with real order info
            resultsDiv.innerHTML = 
                '<h3>üéØ Real Trade Executed Successfully</h3>' +
                '<p><strong>Order ID:</strong> ' + (result.order_id || 'N/A') + '</p>' +
                '<p><strong>Status:</strong> ' + (result.result ? result.result.status : 'N/A') + '</p>' +
                '<p><strong>Strategy:</strong> ' + (result.result ? result.result.strategy : 'N/A') + '</p>' +
                '<p><strong>Message:</strong> ' + (result.result ? result.result.message : 'N/A') + '</p>';
            
            // If streaming was started, update the streaming UI
            if (result.streaming_started) {
                streamingActive = true;
                const btn = document.getElementById('streaming-btn');
                btn.textContent = 'üü¢ Stop Monitoring';
                btn.className = 'btn btn-warning';
                
                // Start auto-refresh to catch order notifications
                startStatusRefresh();
                
                // Add message about monitoring
                addMessageToLog('success', 'Trade submitted! Real-time monitoring active - watching for order updates...');
            }
            
            // Refresh status immediately to show any new messages
            setTimeout(() => {
                refreshStreamingStatus();
            }, 1000);
            
        } else {
            resultsDiv.innerHTML = 
                '<h3>‚ùå Trade Execution Failed</h3>' +
                '<p><strong>Error:</strong> ' + (result.error || 'Unknown error') + '</p>';
        }
    } catch (error) {
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = 
            '<h3>‚ùå Trade Execution Error</h3>' +
            '<p><strong>Error:</strong> ' + error.message + '</p>';
    }
}
</script>
{% endblock %}