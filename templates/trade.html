{% extends "base.html" %}

{% block title %}üéØ Trade Management - SPY Trading System{% endblock %}

{% block content %}
<div class="trade-container">
    <div class="trade-header">
        <h1>üéØ Trade Management</h1>
        <div class="environment-indicator environment-{{ environment.lower() }}">
            {{ environment }} Environment
        </div>
    </div>

    <!-- Authentication Status Panel -->
    <div class="auth-panel">
        <div class="auth-section">
            <h3>üîê {{ environment }} Environment Authentication</h3>
            <div class="auth-status {{ 'authenticated' if authenticated else 'not-authenticated' }}">
                {% if authenticated %}
                    ‚úÖ Connected to {{ environment }}
                    {% if environment == 'SANDBOX' %}
                        (Trading Enabled)
                    {% else %}
                        (Production Mode)
                    {% endif %}
                {% else %}
                    ‚ùå Not Connected to {{ environment }}
                {% endif %}
            </div>
        </div>
        
        {% if not authenticated %}
            <div class="auth-warning">
                ‚ö†Ô∏è Connect to {{ environment.lower() }} to enable trading functionality
            </div>
        {% endif %}
    </div>

    <!-- Authentication Panel (if not authenticated) -->
    {% if authenticated %}
        <!-- Trade data display when authenticated -->
    {% endif %}

    <!-- Parsed Trade Display -->
    {% if parsed_trade %}
    <div class="trade-display">
        <div class="trade-header-info">
            <h2>üìä Current Trade Analysis</h2>
        </div>

        <div class="trade-details">
            <div class="strategy-info">
                {% if parsed_trade and parsed_trade.strategy_type and parsed_trade.strategy_type != None %}
                <div class="strategy-badge strategy-{{ (parsed_trade.strategy_type|string|lower|replace('_', '-')) }}">
                    {{ (parsed_trade.strategy_type|string|replace('_', ' ')|title) }}
                </div>
                {% else %}
                <div class="strategy-badge strategy-unknown">
                    Unknown Strategy
                </div>
                {% endif %}
                <div class="confidence-score">
                    Confidence: {{ parsed_trade.confidence or 'N/A' }}%
                </div>
            </div>

            <div class="trade-specs">
                <div class="spec-group">
                    <h4>üìà Underlying</h4>
                    <span class="spec-value">{{ parsed_trade.underlying or parsed_trade.ticker or 'N/A' }}</span>
                </div>

                <div class="spec-group">
                    <h4>üéØ Strikes</h4>
                    <span class="spec-value">
                        Short: ${{ parsed_trade.short_strike or 'N/A' }} / Long: ${{ parsed_trade.long_strike or 'N/A' }}
                    </span>
                </div>

                <div class="spec-group">
                    <h4>üìÖ Expiration</h4>
                    <span class="spec-value">{{ parsed_trade.expiration or 'N/A' }}</span>
                </div>

                <div class="spec-group">
                    <h4>üí∞ Expected Credit</h4>
                    <span class="spec-value">${{ "%.2f"|format(parsed_trade.credit_received or 0) }}</span>
                </div>

                <div class="spec-group">
                    <h4>üìä Market Bias</h4>
                    <span class="spec-value bias-{{ parsed_trade.market_bias or 'neutral' }}">
                        {{ (parsed_trade.market_bias or 'Unknown').title() }}
                    </span>
                </div>
            </div>

            <!-- Contract Details -->
            <div class="contract-details">
                <h4>üìã Contract Legs</h4>
                <div class="legs-container">
                    {% if parsed_trade and parsed_trade.strategy_type %}
                        {% if parsed_trade.strategy_type == 'BULL_PUT_SPREAD' %}
                            <div class="leg leg-short">
                                <span class="leg-action">SELL TO OPEN</span>
                                <span class="leg-contract">{{ parsed_trade.underlying_symbol or 'SPY' }} {{ parsed_trade.expiration or 'TBD' }}P{{ "%.0f"|format((parsed_trade.short_strike or 0) * 1000) }}</span>
                            </div>
                            <div class="leg leg-long">
                                <span class="leg-action">BUY TO OPEN</span>
                                <span class="leg-contract">{{ parsed_trade.underlying_symbol or 'SPY' }} {{ parsed_trade.expiration or 'TBD' }}P{{ "%.0f"|format((parsed_trade.long_strike or 0) * 1000) }}</span>
                            </div>
                        {% elif parsed_trade.strategy_type == 'BEAR_CALL_SPREAD' %}
                            <div class="leg leg-short">
                                <span class="leg-action">SELL TO OPEN</span>
                                <span class="leg-contract">{{ parsed_trade.underlying_symbol or 'SPY' }} {{ parsed_trade.expiration or 'TBD' }}C{{ "%.0f"|format((parsed_trade.short_strike or 0) * 1000) }}</span>
                            </div>
                            <div class="leg leg-long">
                                <span class="leg-action">BUY TO OPEN</span>
                                <span class="leg-contract">{{ parsed_trade.underlying_symbol or 'SPY' }} {{ parsed_trade.expiration or 'TBD' }}C{{ "%.0f"|format((parsed_trade.long_strike or 0) * 1000) }}</span>
                            </div>
                        {% else %}
                            <div class="leg">
                                <span class="leg-action">Strategy details not available</span>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="leg">
                            <span class="leg-action">No trade data available</span>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Trade Actions -->
            <div class="trade-actions">
                {% if authenticated %}
                    <button id="validateTradeBtn" class="btn btn-secondary">üîç Validate Trade</button>
                    <button id="executeTradeBtn" class="btn btn-primary">üöÄ Execute Trade</button>
                {% else %}
                    <div class="auth-required">
                        <p>üîê {{ environment }} authentication required for trading</p>
                        <button class="btn btn-outline" onclick="window.location.href='/login'">Connect to {{ environment }}</button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="no-trade-data">
        <div class="no-trade-content">
            <h2>üì≠ No Trade Signal Available</h2>
            <p>Request a Grok analysis from the <a href="/dashboard">dashboard</a> to generate trade signals.</p>
            <a href="/dashboard" class="btn btn-primary">üìä Go to Dashboard</a>
        </div>
    </div>
    {% endif %}

    <!-- Execution Results -->
    <div id="executionResults" class="execution-results" style="display: none;">
        <!-- Results will be populated via JavaScript -->
    </div>
</div>

<style>
.trade-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.trade-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    text-align: center;
}

.environment-indicator {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    margin-top: 10px;
}

.environment-sandbox {
    background: rgba(255, 193, 7, 0.2);
    border: 2px solid #ffc107;
}

.environment-production {
    background: rgba(220, 53, 69, 0.2);
    border: 2px solid #dc3545;
}

.auth-panel {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.auth-section {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
}

.auth-status {
    padding: 10px;
    border-radius: 6px;
    text-align: center;
    font-weight: 600;
    margin-top: 10px;
}

.auth-status.authenticated {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.auth-status.not-authenticated {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.trade-display {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
}

.strategy-info {
    text-align: center;
    margin-bottom: 30px;
}

.strategy-badge {
    display: inline-block;
    padding: 12px 24px;
    border-radius: 25px;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 15px;
}

.strategy-bull-put-spread {
    background: #d4edda;
    color: #155724;
    border: 2px solid #28a745;
}

.strategy-bear-call-spread {
    background: #f8d7da;
    color: #721c24;
    border: 2px solid #dc3545;
}

.strategy-unknown {
    background: #f8f9fa;
    color: #6c757d;
    border: 2px solid #6c757d;
}

.confidence-score {
    font-size: 16px;
    color: #6c757d;
}

.trade-specs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.spec-group {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
}

.spec-group h4 {
    margin: 0 0 10px 0;
    color: #495057;
    font-size: 14px;
}

.spec-value {
    font-size: 18px;
    font-weight: 600;
    color: #212529;
}

.contract-details {
    margin-bottom: 30px;
}

.legs-container {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

.leg {
    flex: 1;
    min-width: 250px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
}

.leg-short {
    border-left: 4px solid #dc3545;
}

.leg-long {
    border-left: 4px solid #28a745;
}

.leg-action {
    display: block;
    font-weight: 600;
    color: #495057;
    margin-bottom: 10px;
}

.leg-contract {
    display: block;
    font-size: 16px;
    font-family: monospace;
    color: #212529;
}

.trade-actions {
    text-align: center;
}

.btn {
    display: inline-block;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    margin: 0 10px;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.no-trade-data {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
}

.execution-results {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
}
</style>

<script>
// Trade validation and execution functionality
document.addEventListener('DOMContentLoaded', function() {
    const validateBtn = document.getElementById('validateTradeBtn');
    const executeBtn = document.getElementById('executeTradeBtn');
    const resultsDiv = document.getElementById('executionResults');

    if (validateBtn) {
        validateBtn.addEventListener('click', validateTrade);
    }

    if (executeBtn) {
        executeBtn.addEventListener('click', executeTrade);
    }
});

async function validateTrade() {
    console.log('üîç Validating trade...');
    // Add validation logic here
}

async function executeTrade() {
    console.log('üöÄ Executing trade...');
    const resultsDiv = document.getElementById('executionResults');
    
    try {
        const response = await fetch('/api/execute-trade', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        resultsDiv.style.display = 'block';
        if (result.success) {
            resultsDiv.innerHTML = `
                <h3>‚úÖ Trade Executed Successfully</h3>
                <p>Order ID: ${result.order_id}</p>
                <p>Status: ${result.result.status}</p>
                <p>Message: ${result.result.message}</p>
            `;
        } else {
            resultsDiv.innerHTML = `
                <h3>‚ùå Trade Execution Failed</h3>
                <p>Error: ${result.error}</p>
            `;
        }
    } catch (error) {
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = `
            <h3>‚ùå Trade Execution Error</h3>
            <p>Error: ${error.message}</p>
        `;
    }
}
</script>
{% endblock %}